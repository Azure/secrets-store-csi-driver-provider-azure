parameters:
  - name: azureClusterName
    type: string
  - name: extensionVersion
    type: string
    default: ""
  - name: releaseTrain
    type: string
  - name: configurationSettings
    type: string

steps:
  - script: |
      echo "Installing extension..."

      export AZURE_CLUSTER_NAME=${{ parameters.azureClusterName }}
      echo "Azure cluster name - $(AZURE_CLUSTER_NAME)"

      echo "version - '${{ parameters.extensionVersion }}'"
      if [[ "${{ parameters.extensionVersion }}" != "" ]]; then
        EXTRA_ARGS="--version ${{ parameters.extensionVersion }}"
      fi

      az k8s-extension create \
      --name $(AZURE_CLUSTER_NAME) \
      --extension-type Microsoft.AzureKeyVaultSecretsProvider \
      --scope cluster \
      --cluster-name $(AZURE_CLUSTER_NAME) \
      --resource-group $(AZURE_CLUSTER_NAME) \
      --cluster-type connectedClusters \
      --release-train ${{ parameters.releaseTrain }} \
      --release-namespace kube-system \
      --configuration-settings ${{ parameters.configurationSettings }} \
      $EXTRA_ARGS

      # Arc extensions will go through different phases (Pending, Installed etc.) of installation. We want to make sure extension is 'Installed' before running e2e tests.
      echo "verifying extension install status..."
      for i in $(seq 1 30); do
        installState=$(az k8s-extension show -c $(AZURE_CLUSTER_NAME) -t connectedClusters -n $(AZURE_CLUSTER_NAME) -g $(AZURE_CLUSTER_NAME) --query "installState" -otsv)
        if [ "$installState" == "Installed" ]; then
          echo "AzureKeyVaultSecretsProvider extension is 'Installed'"
          break
        else
          echo "Install state - $installState"
          sleep 2
        fi
      done

      if [ "$installState" != "Installed" ]; then
        echo "failed to install extension."
        exit 1
      fi

      helm ls -A
      helm get values ${{ parameters.azureClusterName }} -n kube-system
      kubectl get pods -n kube-system
    displayName: "install AzureKeyVaultSecretsProvider extension"
    condition: succeeded()