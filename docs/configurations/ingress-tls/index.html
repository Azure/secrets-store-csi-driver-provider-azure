<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.75.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/secrets-store-csi-driver-provider-azure/docs/favicons/favicon.ico><link rel=apple-touch-icon href=/secrets-store-csi-driver-provider-azure/docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/docs/favicons/android-192x192.png sizes=192x192><title>Enable NGINX Ingress Controller with TLS | Azure Key Vault Provider for Secrets Store CSI Driver</title><meta property="og:title" content="Enable NGINX Ingress Controller with TLS"><meta property="og:description" content="This guide demonstrates steps required to setup Secrets Store CSI driver and Azure Key Vault Provider to enable applications to work with NGINX Ingress Controller with TLS certificates stored in Key Vault"><meta property="og:type" content="article"><meta property="og:url" content="https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/ingress-tls/"><meta property="article:modified_time" content="2023-01-20T12:39:09-08:00"><meta property="og:site_name" content="Azure Key Vault Provider for Secrets Store CSI Driver"><meta itemprop=name content="Enable NGINX Ingress Controller with TLS"><meta itemprop=description content="This guide demonstrates steps required to setup Secrets Store CSI driver and Azure Key Vault Provider to enable applications to work with NGINX Ingress Controller with TLS certificates stored in Key Vault"><meta itemprop=dateModified content="2023-01-20T12:39:09-08:00"><meta itemprop=wordCount content="967"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Enable NGINX Ingress Controller with TLS"><meta name=twitter:description content="This guide demonstrates steps required to setup Secrets Store CSI driver and Azure Key Vault Provider to enable applications to work with NGINX Ingress Controller with TLS certificates stored in Key Vault"><link rel=preload href=/secrets-store-csi-driver-provider-azure/docs/scss/main.min.4ca46c7779e12beaabf98a54574d3cfc6e8be930d2014b43de9cc43dac12f2e0.css as=style><link href=/secrets-store-csi-driver-provider-azure/docs/scss/main.min.4ca46c7779e12beaabf98a54574d3cfc6e8be930d2014b43de9cc43dac12f2e0.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/secrets-store-csi-driver-provider-azure/docs/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Azure Key Vault Provider for Secrets Store CSI Driver</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/secrets-store-csi-driver-provider-azure/docs/><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/secrets-store-csi-driver-provider-azure/docs/offline-search-index.b5f7bbcf3481f0d3f934d602b58cdc63.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/secrets-store-csi-driver-provider-azure/docs/offline-search-index.b5f7bbcf3481f0d3f934d602b58cdc63.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=secrets-store-csi-driver-provider-azuredocs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsgetting-started><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/getting-started/installation/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Installation</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsgetting-startedinstallation></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/getting-started/usage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Using the Azure Key Vault Provider</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsgetting-startedusage></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/demos/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Demos</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsdemos><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/demos/standard-walkthrough/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Standard Walkthrough</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsdemosstandard-walkthrough></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/demos/community-demos-and-presentations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Community Demos and Presentations</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsdemoscommunity-demos-and-presentations><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsdemoscommunity-demos-and-presentationshoussem-dellai href=/secrets-store-csi-driver-provider-azure/docs/demos/community-demos-and-presentations/houssem-dellai/>Houssem Dellai - Retrieving database login info from Azure KeyVault</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsdemoscommunity-demos-and-presentationshoussem-dellai-workload-identity href=/secrets-store-csi-driver-provider-azure/docs/demos/community-demos-and-presentations/houssem-dellai-workload-identity/>Houssem Dellai - Retrieving database login info from Azure KeyVault using Workload Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsdemoscommunity-demos-and-presentationsnilesh-gule href=/secrets-store-csi-driver-provider-azure/docs/demos/community-demos-and-presentations/nilesh-gule/>Nilesh Gule - Retrieving RabbitMQ related secret from Azure KeyVault</a></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/configurations/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Configurations</a></li><ul><li class="collapse show" id=secrets-store-csi-driver-provider-azuredocsconfigurations><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsfeature-flags href=/secrets-store-csi-driver-provider-azure/docs/configurations/feature-flags/>Feature Flags</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Identity Access Modes</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modes><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modesworkload-identity-mode href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/workload-identity-mode/>Workload Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modessystem-assigned-msi-mode href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/system-assigned-msi-mode/>System-assigned Managed Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modesuser-assigned-msi-mode href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/user-assigned-msi-mode/>User-assigned Managed Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modesservice-principal-mode href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/service-principal-mode/>Service Principal</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsidentity-access-modespod-identity-mode href=/secrets-store-csi-driver-provider-azure/docs/configurations/identity-access-modes/pod-identity-mode/>Pod Identity</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsmetrics href=/secrets-store-csi-driver-provider-azure/docs/configurations/metrics/>Metrics</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationssync-with-k8s-secrets href=/secrets-store-csi-driver-provider-azure/docs/configurations/sync-with-k8s-secrets/>Sync Mounted Content with Kubernetes Secret</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationssync-multiple-versions href=/secrets-store-csi-driver-provider-azure/docs/configurations/sync-multiple-versions/>Sync Multiple Versions of a Secret</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsenable-auto-rotation-secrets href=/secrets-store-csi-driver-provider-azure/docs/configurations/enable-auto-rotation-secrets/>Enable Auto Rotation of Secrets</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsset-env-var href=/secrets-store-csi-driver-provider-azure/docs/configurations/set-env-var/>Set your Environment Variable to Reference a Kubernetes Secret</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsingress-tls href=/secrets-store-csi-driver-provider-azure/docs/configurations/ingress-tls/>Enable NGINX Ingress Controller with TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationscustom-environments href=/secrets-store-csi-driver-provider-azure/docs/configurations/custom-environments/>Custom Azure Environments</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsgetting-certs-and-keys href=/secrets-store-csi-driver-provider-azure/docs/configurations/getting-certs-and-keys/>Getting Certificates and Keys using Azure Key Vault Provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredocsconfigurationsdeploy-in-openshift href=/secrets-store-csi-driver-provider-azure/docs/configurations/deploy-in-openshift/>Setup Secrets Store CSI Driver on Azure RedHat OpenShift (ARO)</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/troubleshooting/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Troubleshooting</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocstroubleshooting></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/upgrading/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Upgrading</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocsupgrading></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/support/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Support</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocssupport></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/docs/contribution-guidelines/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contribution Guidelines</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredocscontribution-guidelines></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/edit/master/content/en/configurations/ingress-tls.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/new/master/content/en/configurations/ingress-tls.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>Create child page</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new?title=Enable%20NGINX%20Ingress%20Controller%20with%20TLS" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new?assignees=&labels=bug&template=bug-report.md&title=/issues/new" target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#generate-a-tls-cert>Generate a TLS Cert</a><ul><li><a href=#import-the-tls-certificate-to-azure-key-vault>Import the TLS certificate to Azure Key Vault</a></li></ul></li><li><a href=#setup-cluster-prerequisites>Setup Cluster Prerequisites</a><ul><li><a href=#deploy-secrets-store-csi-driver-and-the-azure-key-vault-provider>Deploy Secrets Store CSI Driver and the Azure Key Vault Provider</a></li><li><a href=#optional-deploy-aad-pod-identity>Optional: Deploy AAD Pod Identity</a></li></ul></li><li><a href=#deploy-a-secretsproviderclass-resource>Deploy a SecretsProviderClass Resource</a><ul><li><a href=#create-a-namespace>Create a namespace</a></li><li><a href=#create-the-secretproviderclass>Create the SecretProviderClass</a></li></ul></li><li><a href=#deploy-ingress-controller>Deploy Ingress Controller</a><ul><li><a href=#add-the-official-ingress-chart-repository>Add the official ingress chart repository</a></li><li><a href=#deploy-ingress>Deploy Ingress</a></li></ul></li><li><a href=#deploy-test-apps>Deploy Test Apps</a><ul><li><a href=#deploy-application-with-reference-to-secrets-store-csi>Deploy Application with Reference to Secrets Store CSI</a></li><li><a href=#deploy-application-with-ingress-reference-to-secrets-store-csi>Deploy Application with Ingress reference to Secrets Store CSI</a></li></ul></li><li><a href=#deploy-an-ingress-resource-referencing-the-secret-created-by-the-csi-driver>Deploy an Ingress Resource referencing the Secret created by the CSI driver</a></li><li><a href=#get-the-external-ip-of-the-ingress-controller>Get the External IP of the Ingress Controller</a></li><li><a href=#test-ingress-with-tls>Test Ingress with TLS</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/>Configurations</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/configurations/ingress-tls/>Enable NGINX Ingress Controller with TLS</a></li></ol></nav><div class=td-content><h1>Enable NGINX Ingress Controller with TLS</h1><div class=lead>This guide demonstrates steps required to setup Secrets Store CSI driver and Azure Key Vault Provider to enable applications to work with NGINX Ingress Controller with TLS certificates stored in Key Vault</div><p>For more information on securing an Ingress with TLS, refer to <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/#tls>this guide</a></p><p>Importing the ingress TLS certificate to the cluster can be included in the following deployments:</p><ul><li>Application - Application deployment manifest declares and mounts the csi provider volume. Only when the application is deployed the certificate is made available in the cluster and when it is removed the secret is gone. This scenario fits development teams who are responsible for the application&rsquo;s security infrastructure and their integration with the cluster.</li><li>Ingress Controller - Ingress deployment is modified to declare and mount the csi provider volume. The secret is imported when Ingress pods are created and the application&rsquo;s pods have no access to the TLS certificate. This scenario fits scenarios where one team (i.e. IT) manages and provisions infrastructure and networking components (including HTTPS TLS certificates) and other teams manage application lifecycle. note: in this case, ingress is specific to a single namespace/workload and is deployed in the same namespace as the application.</li></ul><h2 id=generate-a-tls-cert>Generate a TLS Cert</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CERT_NAME</span><span style=color:#ce5c00;font-weight:700>=</span>ingresscert
openssl req -x509 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -out ingress-tls.crt <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -keyout ingress-tls.key <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -subj <span style=color:#4e9a06>&#34;/CN=demo.test.com/O=ingress-tls&#34;</span>
</code></pre></div><h3 id=import-the-tls-certificate-to-azure-key-vault>Import the TLS certificate to Azure Key Vault</h3><p>Convert the .crt certificate to pfx format and import it to Azure Key Vault. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>AKV_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;[YOUR AKV NAME]&#34;</span>
openssl pkcs12 -export -in ingress-tls.crt -inkey ingress-tls.key  -out <span style=color:#000>$CERT_NAME</span>.pfx
<span style=color:#8f5902;font-style:italic># skip Password prompt</span>

az keyvault certificate import --vault-name <span style=color:#000>$AKV_NAME</span> -n <span style=color:#000>$CERT_NAME</span> -f <span style=color:#000>$CERT_NAME</span>.pfx
</code></pre></div><h2 id=setup-cluster-prerequisites>Setup Cluster Prerequisites</h2><h3 id=deploy-secrets-store-csi-driver-and-the-azure-key-vault-provider>Deploy Secrets Store CSI Driver and the Azure Key Vault Provider</h3><p>Deploy the Azure Key Vault Provider and Secrets Store CSI Driver components:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts
helm install csi csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --set secrets-store-csi-driver.syncSecret.enabled<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</code></pre></div><p>Refer to <a href=../../getting-started/installation>installation</a> for more details and validation.</p><h3 id=optional-deploy-aad-pod-identity>Optional: Deploy AAD Pod Identity</h3><p>If using AAD pod identity to access Azure Keyvault, make sure it is <a href=https://azure.github.io/aad-pod-identity/docs/demo/standard_walkthrough/>configured properly</a> in the cluster. Refer to <a href=../identity-access-modes/pod-identity-mode>doc</a> on how to use AAD Pod identity to access keyvault.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>AAD_POD_IDENTITY_NAME</span><span style=color:#ce5c00;font-weight:700>=</span>azure-kv
</code></pre></div><h2 id=deploy-a-secretsproviderclass-resource>Deploy a SecretsProviderClass Resource</h2><h3 id=create-a-namespace>Create a namespace</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>NAMESPACE</span><span style=color:#ce5c00;font-weight:700>=</span>ingress-test
kubectl create ns <span style=color:#000>$NAMESPACE</span>
</code></pre></div><h3 id=create-the-secretproviderclass>Create the SecretProviderClass</h3><ul><li>To provide identity to access key vault, refer to the following <a href=../identity-access-modes>section</a>.</li><li>Set the <code>tenantID</code> and <code>keyvaultName</code></li><li>If using <strong>AAD pod identity</strong> to access Azure Key Vault - set <code>usePodIdentity: "true"</code></li><li>Use <code>objectType: secret</code> for the certificate, as this is the only way to retrieve the certificate and private key from azure key vault as documented <a href=../getting-certs-and-keys>here</a></li><li>Set secret type to <code>kubernetes.io/tls</code></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>TENANT_ID</span><span style=color:#ce5c00;font-weight:700>=[</span>YOUR TENANT ID<span style=color:#ce5c00;font-weight:700>]</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>cat &lt;&lt;EOF | kubectl apply -n $NAMESPACE -f -</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store.csi.x-k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecretProviderClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>azure-tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>azure</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>secretObjects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#8f5902;font-style:italic># secretObjects defines the desired state of synced K8s secret objects</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>secretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingress-tls-csi</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubernetes.io/tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>objectName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>$CERT_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls.key</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>objectName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>$CERT_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>usePodIdentity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>keyvaultName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>$AKV_NAME                 # the name of the KeyVault</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>objects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>|
</span><span style=color:#8f5902;font-style:italic>      array:
</span><span style=color:#8f5902;font-style:italic>        - |
</span><span style=color:#8f5902;font-style:italic>          objectName: $CERT_NAME
</span><span style=color:#8f5902;font-style:italic>          objectType: secret
</span><span style=color:#8f5902;font-style:italic>    tenantID: $TENANT_ID                    # the tenant ID of the KeyVault</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=deploy-ingress-controller>Deploy Ingress Controller</h2><h3 id=add-the-official-ingress-chart-repository>Add the official ingress chart repository</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
</code></pre></div><h3 id=deploy-ingress>Deploy Ingress</h3><p>Depending on the TLS certificate lifecycle, follow one of the following steps:</p><ul><li><h4 id=bind-certificate-to-application>Bind certificate to Application</h4></li></ul><blockquote><p>Application&rsquo;s deployment will reference the csi store provider.</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm install ingress-nginx/ingress-nginx --generate-name <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --namespace <span style=color:#000>$NAMESPACE</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set controller.replicaCount<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set controller.nodeSelector.<span style=color:#4e9a06>&#34;beta\.kubernetes\.io/os&#34;</span><span style=color:#ce5c00;font-weight:700>=</span>linux <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set defaultBackend.nodeSelector.<span style=color:#4e9a06>&#34;beta\.kubernetes\.io/os&#34;</span><span style=color:#ce5c00;font-weight:700>=</span>linux
</code></pre></div><p>Next, <a href=#deploy-application-with-reference-to-secrets-store-csi>Deploy the application</a>.</p><ul><li><h4 id=bind-certificate-to-ingress>Bind certificate to Ingress</h4></li></ul><blockquote><p>NOTE: Ingress controller references a Secrets Store CSI volume and a <code>secretProviderClass</code> object created earlier. A Kubernetes secret <code>ingress-tls-csi</code> will be created by the CSI driver as a result of ingress controller creation.</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm install ingress-nginx/ingress-nginx --generate-name <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --namespace <span style=color:#000>$NAMESPACE</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set controller.replicaCount<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set controller.nodeSelector.<span style=color:#4e9a06>&#34;beta\.kubernetes\.io/os&#34;</span><span style=color:#ce5c00;font-weight:700>=</span>linux <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set defaultBackend.nodeSelector.<span style=color:#4e9a06>&#34;beta\.kubernetes\.io/os&#34;</span><span style=color:#ce5c00;font-weight:700>=</span>linux <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --set controller.podLabels.aadpodidbinding<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$AAD_POD_IDENTITY_NAME</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span><span style=color:#4e9a06>controller:
</span><span style=color:#4e9a06>  extraVolumes:
</span><span style=color:#4e9a06>      - name: secrets-store-inline
</span><span style=color:#4e9a06>        csi:
</span><span style=color:#4e9a06>          driver: secrets-store.csi.k8s.io
</span><span style=color:#4e9a06>          readOnly: true
</span><span style=color:#4e9a06>          volumeAttributes:
</span><span style=color:#4e9a06>            secretProviderClass: &#34;azure-tls&#34;
</span><span style=color:#4e9a06>          nodePublishSecretRef:
</span><span style=color:#4e9a06>            name: secrets-store-creds
</span><span style=color:#4e9a06>  extraVolumeMounts:
</span><span style=color:#4e9a06>      - name: secrets-store-inline
</span><span style=color:#4e9a06>        mountPath: &#34;/mnt/secrets-store&#34;
</span><span style=color:#4e9a06>        readOnly: true
</span><span style=color:#4e9a06>EOF</span>
</code></pre></div><p>If not using <a href=../identity-access-modes/service-principal-mode>service principal mode</a>, remove the following snippet from the script:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>            nodePublishSecretRef:
              name: secrets-store-creds
</code></pre></div><h4 id=check-for-the-kubernetes-secret-created-by-the-csi-driver-ingress-bound-certificate>Check for the Kubernetes Secret created by the CSI driver (ingress-bound certificate)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get secret -n <span style=color:#000>$NAMESPACE</span>

NAME                                             TYPE                                  DATA   AGE
ingress-tls-csi                                  kubernetes.io/tls                     <span style=color:#0000cf;font-weight:700>2</span>      1m34s
</code></pre></div><p>Next, <a href=#deploy-application-with-ingress-reference-to-secrets-store-csi>Deploy the application</a>.</p><h2 id=deploy-test-apps>Deploy Test Apps</h2><p>Depending on the TLS certificate lifecycle, follow one of the following steps:</p><ul><li><h3 id=deploy-application-with-reference-to-secrets-store-csi>Deploy Application with Reference to Secrets Store CSI</h3></li></ul><blockquote><p>NOTE: These apps reference a Secrets Store CSI volume and a <code>secretProviderClass</code> object created earlier. A Kubernetes secret <code>ingress-tls-csi</code> will be created by the CSI driver as a result of the app creation in the same namespace.</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>csi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>driver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store.csi.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>volumeAttributes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>secretProviderClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;azure-tls&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>nodePublishSecretRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-creds</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>If not using <a href=../identity-access-modes/service-principal-mode>service principal mode</a>, remove the following snippet from <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-one.yaml>deployment-app-one.yaml</a> and <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-two.yaml>deployment-app-two.yaml</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>nodePublishSecretRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-creds</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=deploy-the-test-apps-application-bound-certificate>Deploy the test apps (application-bound certificate)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-one.yaml -n <span style=color:#000>$NAMESPACE</span>
kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-two.yaml -n <span style=color:#000>$NAMESPACE</span>
</code></pre></div><h4 id=check-for-the-kubernetes-secret-created-by-the-csi-driver-application-bound-certificate>Check for the Kubernetes Secret created by the CSI driver (application-bound certificate)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get secret -n <span style=color:#000>$NAMESPACE</span>

NAME                                             TYPE                                  DATA   AGE
ingress-tls-csi                                  kubernetes.io/tls                     <span style=color:#0000cf;font-weight:700>2</span>      1m34s
</code></pre></div><p>Next, <a href=#deploy-an-ingress-resource-referencing-the-secret-created-by-the-csi-driver>Deploy the ingress resource</a></p><ul><li><h3 id=deploy-application-with-ingress-reference-to-secrets-store-csi>Deploy Application with Ingress reference to Secrets Store CSI</h3></li></ul><p>remove the following snippet from <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-one.yaml>deployment-app-one.yaml</a> and <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-two.yaml>deployment-app-two.yaml</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/mnt/secrets-store&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>csi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>driver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store.csi.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>volumeAttributes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>secretProviderClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;azure-tls&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>nodePublishSecretRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store-creds</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h4 id=deploy-the-test-apps-ingress-bound-certificate>Deploy the test apps (ingress-bound certificate)</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-one.yaml -n <span style=color:#000>$NAMESPACE</span>
kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/deployment-app-two.yaml -n <span style=color:#000>$NAMESPACE</span>
</code></pre></div><p>Next, <a href=#deploy-an-ingress-resource-referencing-the-secret-created-by-the-csi-driver>Deploy the ingress resource</a></p><h2 id=deploy-an-ingress-resource-referencing-the-secret-created-by-the-csi-driver>Deploy an Ingress Resource referencing the Secret created by the CSI driver</h2><blockquote><p>NOTE: The ingress resource references the Kubernetes secret <code>ingress-tls-csi</code> created by the CSI driver as a result of the app creation.<br>The following snippet shows the code which makes this happen:</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>demo.test.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>secretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingress-tls-csi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/docs/sample/ingress-controller-tls/ingress.yaml -n <span style=color:#000>$NAMESPACE</span>
</code></pre></div><h2 id=get-the-external-ip-of-the-ingress-controller>Get the External IP of the Ingress Controller</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> kubectl get service -l <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>nginx-ingress --namespace <span style=color:#000>$NAMESPACE</span>
NAME                                       TYPE           CLUSTER-IP     EXTERNAL-IP      PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>                      AGE
nginx-ingress-1588032400-controller        LoadBalancer   10.0.255.157   52.xx.xx.xx      80:31293/TCP,443:31265/TCP   19m
nginx-ingress-1588032400-default-backend   ClusterIP      10.0.223.214   &lt;none&gt;           80/TCP                       19m
</code></pre></div><h2 id=test-ingress-with-tls>Test Ingress with TLS</h2><p>Using <code>curl</code> to verify ingress configuration using TLS.
Replace the public IP with the external IP of the ingress controller service from the previous step.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -v -k --resolve demo.test.com:443:52.xx.xx.xx https://demo.test.com

<span style=color:#8f5902;font-style:italic># You should see the following in your output</span>
*  subject: <span style=color:#000>CN</span><span style=color:#ce5c00;font-weight:700>=</span>demo.test.com<span style=color:#000;font-weight:700>;</span> <span style=color:#000>O</span><span style=color:#ce5c00;font-weight:700>=</span>ingress-tls
*  start date: Apr <span style=color:#0000cf;font-weight:700>15</span> 04:23:46 <span style=color:#0000cf;font-weight:700>2020</span> GMT
*  expire date: Apr <span style=color:#0000cf;font-weight:700>15</span> 04:23:46 <span style=color:#0000cf;font-weight:700>2021</span> GMT
*  issuer: <span style=color:#000>CN</span><span style=color:#ce5c00;font-weight:700>=</span>demo.test.com<span style=color:#000;font-weight:700>;</span> <span style=color:#000>O</span><span style=color:#ce5c00;font-weight:700>=</span>ingress-tls
*  SSL certificate verify result: self signed certificate <span style=color:#ce5c00;font-weight:700>(</span>18<span style=color:#ce5c00;font-weight:700>)</span>, continuing anyway.
</code></pre></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified January 20, 2023: <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/commit/c88f03f1c0020eb3b0f9951f4454c822e7f4ce3b>docs: Update documentation to reflect change from 'tenantId' to 'tenantID' (#1057) (c88f03f)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://kubernetes.slack.com/archives/C013PUP2WRK><i class="fab fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Azure/secrets-store-csi-driver-provider-azure><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Azure Compute OSS Upstream Team All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/secrets-store-csi-driver-provider-azure/docs/js/main.min.f820bfc507c3ebefe17f8881ec4ee10013f3b89ad9555a50acf9bb1771e6823f.js integrity="sha256-+CC/xQfD6+/hf4iB7E7hABPzuJrZVVpQrPm7F3Hmgj8=" crossorigin=anonymous></script></body></html>