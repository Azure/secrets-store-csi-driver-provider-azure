<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.75.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/secrets-store-csi-driver-provider-azure/favicons/favicon.ico><link rel=apple-touch-icon href=/secrets-store-csi-driver-provider-azure/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/secrets-store-csi-driver-provider-azure/favicons/android-192x192.png sizes=192x192><title>Pod Identity | Azure Key Vault Provider for Secrets Store CSI Driver</title><meta property="og:title" content="Pod Identity"><meta property="og:description" content="Use Pod Identity to access Keyvault."><meta property="og:type" content="article"><meta property="og:url" content="https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/pod-identity-mode/"><meta property="article:modified_time" content="2021-10-26T10:39:54-07:00"><meta property="og:site_name" content="Azure Key Vault Provider for Secrets Store CSI Driver"><meta itemprop=name content="Pod Identity"><meta itemprop=description content="Use Pod Identity to access Keyvault."><meta itemprop=dateModified content="2021-10-26T10:39:54-07:00"><meta itemprop=wordCount content="646"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Pod Identity"><meta name=twitter:description content="Use Pod Identity to access Keyvault."><link rel=preload href=/secrets-store-csi-driver-provider-azure/scss/main.min.265e25987f1ebc366519dbb651d5dae8ec9c3b7dafaba1ff236240d5774ecae7.css as=style><link href=/secrets-store-csi-driver-provider-azure/scss/main.min.265e25987f1ebc366519dbb651d5dae8ec9c3b7dafaba1ff236240d5774ecae7.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/secrets-store-csi-driver-provider-azure/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Azure Key Vault Provider for Secrets Store CSI Driver</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/secrets-store-csi-driver-provider-azure/><span class=active>Documentation</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/secrets-store-csi-driver-provider-azure/offline-search-index.226e975addbd9dd04810910125683d1c.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/secrets-store-csi-driver-provider-azure/offline-search-index.226e975addbd9dd04810910125683d1c.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=secrets-store-csi-driver-provider-azure><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuregetting-started><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/getting-started/installation/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Installation</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuregetting-startedinstallation></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/getting-started/usage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Using the Azure Key Vault Provider</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuregetting-startedusage></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/demos/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Demos</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredemos><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/demos/standard-walkthrough/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Standard Walkthrough</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredemosstandard-walkthrough></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/demos/community-demos-and-presentations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Community Demos and Presentations</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuredemoscommunity-demos-and-presentations><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredemoscommunity-demos-and-presentationshoussem-dellai href=/secrets-store-csi-driver-provider-azure/demos/community-demos-and-presentations/houssem-dellai/>Houssem Dellai - Retrieving database login info from Azure KeyVault</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azuredemoscommunity-demos-and-presentationsnilesh-gule href=/secrets-store-csi-driver-provider-azure/demos/community-demos-and-presentations/nilesh-gule/>Nilesh Gule - Retrieving RabbitMQ related secret from Azure KeyVault</a></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/configurations/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Configurations</a></li><ul><li class="collapse show" id=secrets-store-csi-driver-provider-azureconfigurations><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsfeature-flags href=/secrets-store-csi-driver-provider-azure/configurations/feature-flags/>Feature Flags</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Identity Access Modes</a></li><ul><li class="collapse show" id=secrets-store-csi-driver-provider-azureconfigurationsidentity-access-modes><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsidentity-access-modesservice-principal-mode href=/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/service-principal-mode/>Service Principal</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-secrets-store-csi-driver-provider-azureconfigurationsidentity-access-modespod-identity-mode href=/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/pod-identity-mode/>Pod Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsidentity-access-modesuser-assigned-msi-mode href=/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/user-assigned-msi-mode/>User-assigned Managed Identity</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsidentity-access-modessystem-assigned-msi-mode href=/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/system-assigned-msi-mode/>System-assigned Managed Identity</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsmetrics href=/secrets-store-csi-driver-provider-azure/configurations/metrics/>Metrics</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationssync-with-k8s-secrets href=/secrets-store-csi-driver-provider-azure/configurations/sync-with-k8s-secrets/>Sync Mounted Content with Kubernetes Secret</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsenable-auto-rotation-secrets href=/secrets-store-csi-driver-provider-azure/configurations/enable-auto-rotation-secrets/>Enable Auto Rotation of Secrets</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsset-env-var href=/secrets-store-csi-driver-provider-azure/configurations/set-env-var/>Set your Environment Variable to Reference a Kubernetes Secret</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsingress-tls href=/secrets-store-csi-driver-provider-azure/configurations/ingress-tls/>Enable NGINX Ingress Controller with TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationscustom-environments href=/secrets-store-csi-driver-provider-azure/configurations/custom-environments/>Custom Azure Environments</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsgetting-certs-and-keys href=/secrets-store-csi-driver-provider-azure/configurations/getting-certs-and-keys/>Getting Certificates and Keys using Azure Key Vault Provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-secrets-store-csi-driver-provider-azureconfigurationsdeploy-in-openshift href=/secrets-store-csi-driver-provider-azure/configurations/deploy-in-openshift/>Setup Secrets Store CSI Driver on Azure RedHat OpenShift (ARO)</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/troubleshooting/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Troubleshooting</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuretroubleshooting></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/upgrading/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Upgrading</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azureupgrading></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/support/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Support</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azuresupport></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/secrets-store-csi-driver-provider-azure/contribution-guidelines/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contribution Guidelines</a></li><ul><li class=collapse id=secrets-store-csi-driver-provider-azurecontribution-guidelines></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/edit/master/content/en/configurations/identity-access-modes/pod-identity-mode.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/new/master/content/en/configurations/identity-access-modes/pod-identity-mode.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>Create child page</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new?title=Pod%20Identity" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new?assignees=&labels=bug&template=bug-report.md&title=/issues/new" target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#configure-aad-pod-identity-to-access-keyvault>Configure AAD Pod Identity to access Keyvault</a></li><li><a href=#pros>Pros:</a></li><li><a href=#cons>Cons:</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/>Configurations</a></li><li class=breadcrumb-item><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/>Identity Access Modes</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/identity-access-modes/pod-identity-mode/>Pod Identity</a></li></ol></nav><div class=td-content><h1>Pod Identity</h1><div class=lead>Use Pod Identity to access Keyvault.</div><details><summary>Examples</summary><ul><li><code>SecretProviderClass</code></li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># This is a SecretProviderClass example using aad-pod-identity to access Key Vault</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store.csi.x-k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SecretProviderClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>azure-kvname-podid</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>azure</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>usePodIdentity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># set to true for pod identity access mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>keyvaultName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;kvname&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cloudName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                   </span><span style=color:#8f5902;font-style:italic># [OPTIONAL for Azure] if not provided, azure environment will default to AzurePublicCloud</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>objects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>|
</span><span style=color:#8f5902;font-style:italic>      array:
</span><span style=color:#8f5902;font-style:italic>        - |
</span><span style=color:#8f5902;font-style:italic>          objectName: secret1
</span><span style=color:#8f5902;font-style:italic>          objectType: secret        # object types: secret, key or cert
</span><span style=color:#8f5902;font-style:italic>          objectVersion: &#34;&#34;         # [OPTIONAL] object versions, default to latest if empty
</span><span style=color:#8f5902;font-style:italic>        - |
</span><span style=color:#8f5902;font-style:italic>          objectName: key1
</span><span style=color:#8f5902;font-style:italic>          objectType: key
</span><span style=color:#8f5902;font-style:italic>          objectVersion: &#34;&#34;
</span><span style=color:#8f5902;font-style:italic>    tenantId: &#34;tid&#34;                    # the tenant ID of the KeyVault  
</span></code></pre></div><ul><li><code>Pod</code> yaml</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># This is a sample pod definition for using SecretProviderClass and aad-pod-identity to access Key Vault</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Pod</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>busybox-secrets-store-inline-podid</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>aadpodidbinding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;demo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Set the label value to match selector defined in AzureIdentityBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>busybox</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>k8s.gcr.io/e2e-test-images/busybox:1.29</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;/bin/sleep&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#4e9a06>&#34;10000&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store01-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/mnt/secrets-store&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store01-inline</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>csi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>driver</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>secrets-store.csi.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>readOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>volumeAttributes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>secretProviderClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;azure-kvname-podid&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></details><h2 id=configure-aad-pod-identity-to-access-keyvault>Configure AAD Pod Identity to access Keyvault</h2><p><strong>Prerequisites</strong></p><p>💡 Make sure you have installed pod identity to your Kubernetes cluster</p><p><strong>This project makes use of the <a href=https://github.com/Azure/aad-pod-identity#getting-started>aad-pod-identity</a> project to handle the identity management of the pods. Reference the aad-pod-identity README if you need further instructions on any of these steps.</strong></p><p>Not all steps need to be followed on the instructions for the aad-pod-identity project as we will also complete some of the steps on our installation here.</p><ol><li><p>Install the aad-pod-identity components to your cluster</p><ul><li><p>💡 Follow the <a href=https://azure.github.io/aad-pod-identity/docs/getting-started/role-assignment/>Role assignment</a> documentation to setup all the required roles for aad-pod-identity components.</p></li><li><p>Install the RBAC enabled aad-pod-identiy infrastructure components:</p><pre><code>kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/master/deploy/infra/deployment-rbac.yaml
</code></pre></li></ul></li><li><p>Create an Azure User-assigned Managed Identity</p><p>Create an Azure User-assigned Managed Identity with the following command.
Get <code>clientId</code> and <code>id</code> from the output.</p><pre><code>az identity create -g &lt;resourcegroup&gt; -n &lt;idname&gt;
</code></pre></li><li><p>Assign permissions to new identity
Ensure your Azure user identity has all the required permissions to read the keyvault instance and to access content within your key vault instance.
If not, you can run the following using the Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># set policy to access keys in your keyvault</span>
az keyvault set-policy -n <span style=color:#000>$KEYVAULT_NAME</span> --key-permissions get --spn &lt;YOUR AZURE USER IDENTITY CLIENT ID&gt;
<span style=color:#8f5902;font-style:italic># set policy to access secrets in your keyvault</span>
az keyvault set-policy -n <span style=color:#000>$KEYVAULT_NAME</span> --secret-permissions get --spn &lt;YOUR AZURE USER IDENTITY CLIENT ID&gt;
<span style=color:#8f5902;font-style:italic># set policy to access certs in your keyvault</span>
az keyvault set-policy -n <span style=color:#000>$KEYVAULT_NAME</span> --certificate-permissions get --spn &lt;YOUR AZURE USER IDENTITY CLIENT ID&gt;
</code></pre></div></li><li><p>Add an <code>AzureIdentity</code> for the new identity to your cluster</p><p>Edit and save this as <code>aadpodidentity.yaml</code></p><p>Set <code>type: 0</code> for User-Assigned Managed Identity; <code>type: 1</code> for Service Principal
In this case, we are using managed service identity, <code>type: 0</code>.
Create a new name for the AzureIdentity.
Set <code>resourceID</code> to <code>id</code> of the Azure User Identity created from the previous step.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;aadpodidentity.k8s.io/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AzureIdentity</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;any-name&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourceID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/subscriptions/&lt;subid&gt;/resourcegroups/&lt;resourcegroup&gt;/providers/Microsoft.ManagedIdentity/userAssignedIdentities/&lt;idname&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>clientID</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;clientid&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl create -f aadpodidentity.yaml
</code></pre></div></li><li><p>Add <code>AzureIdentityBinding</code> for the <code>AzureIdentity</code> to your cluster</p><p>Edit and save this as <code>aadpodidentitybinding.yaml</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;aadpodidentity.k8s.io/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AzureIdentityBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;any-name&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>azureIdentity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;name of the AzureIdentity created in previous step&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;label value to match in your pod&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><pre><code>kubectl create -f aadpodidentitybinding.yaml
</code></pre></li><li><p>Add the following to <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/examples/pod-identity/pod-inline-volume-pod-identity.yaml>this</a> deployment yaml:</p><p>Include the <code>aadpodidbinding</code> label matching the <code>selector</code> value set in the previous step so that this pod will be assigned an identity</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>aadpodidbinding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;AzureIdentityBinding Selector created from previous step&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>Update <a href=https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/examples/pod-identity/v1alpha1_secretproviderclass_pod_identity.yaml>this sample deployment</a> to create a <code>SecretProviderClass</code> resource with <code>usePodIdentity: "true"</code> to provide Azure-specific parameters for the Secrets Store CSI driver.</p><p>Make sure to set <code>usepodidentity</code> to <code>true</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>usepodidentity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>Deploy your app</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f pod.yaml
</code></pre></div></li></ol><p><strong>NOTE</strong> When using the <code>Pod Identity</code> option mode, there can be some amount of delay in obtaining the objects from keyvault. During the pod creation time, in this particular mode <code>aad-pod-identity</code> will need to create the <code>AzureAssignedIdentity</code> for the pod based on the <code>AzureIdentity</code> and <code>AzureIdentityBinding</code>, retrieve token for keyvault. This process can take time to complete and it&rsquo;s possible for the pod volume mount to fail during this time. When the volume mount fails, kubelet will keep retrying until it succeeds. So the volume mount will eventually succeed after the whole process for retrieving the token is complete.</p><br><h2 id=pros>Pros:</h2><ol><li>Provides secure way to access cloud resources that depends on Azure Active Directory as identity provider.</li></ol><h2 id=cons>Cons:</h2><ol><li>Supported only on Linux</li></ol><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified October 26, 2021: <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/commit/adb7285c18bfcede665d713e5169f6d9b836dc5e>docs: update api version to v1 and add upgrade guide (#681) (adb7285)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://kubernetes.slack.com/archives/C013PUP2WRK><i class="fab fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/Azure/secrets-store-csi-driver-provider-azure><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 Azure Compute OSS Upstream Team All Rights Reserved</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/secrets-store-csi-driver-provider-azure/js/main.min.f820bfc507c3ebefe17f8881ec4ee10013f3b89ad9555a50acf9bb1771e6823f.js integrity="sha256-+CC/xQfD6+/hf4iB7E7hABPzuJrZVVpQrPm7F3Hmgj8=" crossorigin=anonymous></script></body></html>